import { readFileSync, readdirSync } from 'fs';
import { resolve as pathResolve, dirname, basename } from 'path';

/**
 * ESBuild plugin to handle import.meta.glob for SVG files and ?raw imports
 * This replaces Vite's import.meta.glob functionality for production builds
 */
export const globSvgPlugin = () => ({
  name: 'glob-svg',
  setup(build) {
    // Handle ?raw imports for SVG files
    build.onResolve({ filter: /\.svg\?raw$/ }, (args) => {
      const pathWithoutQuery = args.path.replace('?raw', '');
      const resolvedPath = pathResolve(args.resolveDir, pathWithoutQuery);
      return {
        path: resolvedPath,
        namespace: 'svg-raw',
      };
    });

    // Load SVG files as raw strings
    build.onLoad({ filter: /.*/, namespace: 'svg-raw' }, (args) => {
      try {
        const content = readFileSync(args.path, 'utf8');
        return {
          contents: `export default ${JSON.stringify(content)};`,
          loader: 'js',
        };
      } catch (err) {
        console.warn(`Could not load SVG file: ${args.path}`, err.message);
        return {
          contents: 'export default "";',
          loader: 'js',
        };
      }
    });

    // Helper function to read SVG files from a directory
    const readSvgFiles = (dirPath) => {
      try {
        const files = readdirSync(dirPath).filter((f) => f.endsWith('.svg'));
        return files.reduce((acc, file) => {
          const key = file.replace('.svg', '');
          const content = readFileSync(pathResolve(dirPath, file), 'utf8');
          acc[key] = content;
          return acc;
        }, {});
      } catch (err) {
        console.warn(`Could not read directory: ${dirPath}`);
        return {};
      }
    };

    // Handle the icons.ts file - only includes standard icons
    // (functional/distinctive are lazy-loaded via separate chunks)
    build.onLoad({ filter: /icons\.ts$/ }, async (args) => {
      try {
        const source = readFileSync(args.path, 'utf8');

        if (!source.includes('import.meta.glob')) {
          return null;
        }

        const fileName = basename(args.path);

        // Handle functional-icons.ts
        if (fileName === 'functional-icons.ts') {
          const functionalDir = pathResolve(dirname(args.path), 'functional');
          const functionalObj = readSvgFiles(functionalDir);

          return {
            contents: `export const functionalIcons = ${JSON.stringify(functionalObj)};`,
            loader: 'ts',
            resolveDir: dirname(args.path),
          };
        }

        // Handle distinctive-icons.ts
        if (fileName === 'distinctive-icons.ts') {
          const distinctiveDir = pathResolve(dirname(args.path), 'distinctive');
          const distinctiveObj = readSvgFiles(distinctiveDir);

          return {
            contents: `export const distinctiveIcons = ${JSON.stringify(distinctiveObj)};`,
            loader: 'ts',
            resolveDir: dirname(args.path),
          };
        }

        // Handle main icons.ts - standard icons only, with keys/types for all sets
        const iconsDir = pathResolve(dirname(args.path), 'icons');
        const functionalDir = pathResolve(dirname(args.path), 'functional');
        const distinctiveDir = pathResolve(dirname(args.path), 'distinctive');

        const iconsObj = readSvgFiles(iconsDir);
        const functionalKeys = Object.keys(readSvgFiles(functionalDir));
        const distinctiveKeys = Object.keys(readSvgFiles(distinctiveDir));

        const replacementCode = `// Generated by esbuild-plugin-glob-svg for production builds

export const icons = ${JSON.stringify(iconsObj)};

export const iconKeys = ${JSON.stringify(Object.keys(iconsObj))} as (keyof typeof icons)[];
export const functionalIconKeys = ${JSON.stringify(functionalKeys)} as string[];
export const distinctiveIconKeys = ${JSON.stringify(distinctiveKeys)} as string[];

export type IconName = ${
          Object.keys(iconsObj)
            .map((k) => `"${k}"`)
            .join(' | ') || 'string'
        };
export type FunctionalIconName = ${
          functionalKeys.map((k) => `"${k}"`).join(' | ') || 'string'
        };
export type DistinctiveIconName = ${
          distinctiveKeys.map((k) => `"${k}"`).join(' | ') || 'string'
        };

export default icons;
`;

        return {
          contents: replacementCode,
          loader: 'ts',
          resolveDir: dirname(args.path),
        };
      } catch (err) {
        console.warn(
          'Could not process icons file with glob-svg plugin:',
          err.message,
        );
        return null;
      }
    });
  },
});
